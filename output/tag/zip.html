<!DOCTYPE html>
<html lang="en">
<head>
        <title>DavidJB.com - zip</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../theme/css/main.css" type="text/css" />
                <link href="http://davidjb.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="DavidJB.com Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie.css"/>
                <script src="../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">DavidJB.com  <strong>Ramblings about Plone, Pyramid, Python, the web, Linux, roses and more.</strong></a></h1>
                <nav><ul>
                                                    <li><a href="../pages/about-me.html">About me</a></li>
                                    <li><a href="../pages/blog.html">Blog</a></li>
                                    <li><a href="../pages/projects.html">Projects</a></li>
                                                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../blog/2009/04/plone-issues-with-products/">Plone: Issues with products</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2009-04-23T09:15:00">
                Thu 23 April 2009
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/davidjb.html">davidjb</a>
        </address>
        <p>In <a href="../category/plone.html">Plone</a>. </p>
<p>tags: <a href="../tag/plone.html">plone</a><a href="../tag/problem.html">problem</a><a href="../tag/products.html">products</a><a href="../tag/zip.html">zip</a></p>
</footer><!-- /.post-info --><p>Oh dear. Products in Plone that don't care to uninstall themselves at
all when removed. One such product that comes to mind is
ZipFileTransport.</p>
<p>I could go into depth all day about its failure to uninstall, but in
specific, it's this line of code in its setupHandlers.py file that kills
me:</p>
<pre class="code python literal-block">
<span class="n">sm</span><span class="o">.</span><span class="n">registerUtility</span><span class="p">(</span><span class="n">ZipFileTransportUtility</span><span class="p">(</span><span class="s">'zipfiletransport'</span><span class="p">),</span> <span class="n">IZipFileTransportUtility</span><span class="p">)</span>
</pre>
<p>Now, where's the unregisterUtility called? Nowhere, unfortunately. So
when one tries to go and install/uninstall/reinstall/do certain things
on the site, you get a nasty failure message about trying to unpickle a
python object:</p>
<pre class="code pytb literal-block">
<span class="x">2009-04-23 10:19:19 ERROR Zope.SiteErrorLog http://localhost:8080/eresearch/portal_quickinstaller/uninstallProductsTraceback (innermost last):
Module ZPublisher.Publish, line 125, in publish
Module Zope2.App.startup, line 238, in commit
Module transaction._manager, line 96, in commit
Module transaction._transaction, line 395, in commit
Module transaction._transaction, line 495, in _commitResources
Module ZODB.Connection, line 510, in commit
Module ZODB.Connection, line 555, in _commit
Module ZODB.Connection, line 582, in _store_objects
Module ZODB.serialize, line 407, in serialize
Module ZODB.serialize, line 416, in _dump
PicklingError: Can't pickle: import of module Products.ZipFileTransport.utilities.interfaces failed</span>
</pre>
<div class="section" id="solution">
<h2>Solution?</h2>
<p>Okay, I found the unregisterUtility function in zope.component, and it
can be accessed by something like this (ipython session, of course):
(You'll need at least the ZFT parts below present to import them).</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">zope.app.component.hooks</span> <span class="kn">import</span> <span class="n">setSite</span>
<span class="kn">from</span> <span class="nn">zope.component</span> <span class="kn">import</span> <span class="n">getSiteManager</span>
<span class="kn">from</span> <span class="nn">Products.ZipFileTransport.utilities.interfaces</span> <span class="kn">import</span> <span class="n">IZipFileTransportUtility</span>
<span class="kn">from</span> <span class="nn">Products.ZipFileTransport.utilities.utils</span> <span class="kn">import</span> <span class="n">ZipFileTransportUtility</span>
<span class="n">setSite</span><span class="p">(</span><span class="n">portal</span><span class="p">)</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">getSiteManager</span><span class="p">()</span>
<span class="n">sm</span><span class="o">.</span><span class="n">unregisterUtility</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">provided</span><span class="o">=</span><span class="n">IZipFileTransportUtility</span><span class="p">)</span>

<span class="c">#Even though unregister happened, it probably said it worked but left crap around.</span>
<span class="c">#Let's clean it up</span>

<span class="c">#This intclass variable might not be right.  It's going to be the key present below,</span>
<span class="c">#so you can always find the right InterfaceClass manually and set it accordingly.</span>
<span class="n">intclass</span> <span class="o">=</span> <span class="n">IZipFileTransportUtility</span>
<span class="k">del</span> <span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">_adapters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">intclass</span><span class="p">]</span>
<span class="k">del</span> <span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">_subscribers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">intclass</span><span class="p">]</span>

<span class="c">#From here, search for 'Zip' to see if it's gone</span>
<span class="c">#Each should return -1.  If not, you've done something wrong!</span>
<span class="nb">str</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">_adapters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'Zip'</span><span class="p">)</span>
<span class="nb">str</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">_subscribers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'Zip'</span><span class="p">)</span>
<span class="nb">str</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'Zip'</span><span class="p">)</span>
</pre>
<p>And thus ends the tyranny of ZipFileTransport.</p>
<p><strong>Edit:</strong> I should make it clear that to run the above commands you need
to have a handle to your Plone site object, and be pre-set as the
'portal' variable. If you set up ipython like so:
<a class="reference external" href="http://plone.org/documentation/kb/setup-ipython-for-zope">http://plone.org/documentation/kb/setup-ipython-for-zope</a> then that takes
care of things automatically and gives you interactive handles to your
portal and Zope app root. If you're not using this, then figure out how
to set 'portal' manually to be your Plone site object (not a string or
name, but the actual object) and run the rest of the lines of code.</p>
<p>Also, I'm not sure whether you need to commit your changes or not. If
you find the changes don't stick, then try this in your ipython session:</p>
<pre class="code python literal-block">
<span class="kn">import</span> <span class="nn">transaction</span>
<span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre>
</div>
<p>There are <a href="../blog/2009/04/plone-issues-with-products/#disqus_thread">comments</a>.</p>                </article>
                                    <p class="paginator">
        Page 1 / 1
    </p>
                            </aside><!-- /#featured -->
                                                </ol><!-- /#posts-list -->
                        </section><!-- /#content -->
                    <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://planet.plone.org">Planet Plone</a></li>
                                                    <li><a href=""></a></li>
                                                    <li><a href=""></a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://davidjb.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="http://git.io/djb">GitHub</a></li>
                                                    <li><a href="http://twitter.com/davidjb_">Twitter</a></li>
                                                    <li><a href="http://linkedin.com/in/davidbeitey">LinkedIn</a></li>
                                                    <li><a href="http://facebook.com/david.beitey">Facebook</a></li>
                                                    <li><a href="https://plus.google.com/u/0/106527454335411502430">Google+</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24253455-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'davidjb';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>