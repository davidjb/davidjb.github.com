<!DOCTYPE html>
<html lang="en">
<head>
        <title>DavidJB.com - zodb</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://davidjb.com/theme/css/main.css" type="text/css" />
                <link href="http://davidjb.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="DavidJB.com Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://davidjb.com/css/ie.css"/>
                <script src="http://davidjb.com/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://davidjb.com/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://davidjb.com/">DavidJB.com  <strong>Ramblings about Plone, Pyramid, Python, the web, Linux, roses and more.</strong></a></h1>
                <nav><ul>
                                                    <li><a href="http://davidjb.com/about.html">About&nbsp;me</a></li>
                                    <li><a href="http://davidjb.com/blog/index.html">Blog</a></li>
                                    <li><a href="http://davidjb.com/projects.html">Projects</a></li>
                                                                </ul></nav>
        </header><!-- /#banner -->
                
            

                            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://davidjb.com/blog/2010/07/plonezope-truncating-a-data-fs-back-to-a-certain-datetime/">Plone/Zope: Truncating a Data.fs back to a certain&nbsp;date/time</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2010-07-20T13:39:00">
                Tue 20 July 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="http://davidjb.com/author/davidjb.html">davidjb</a>
        </address>
        <p>In <a href="http://davidjb.com/category/plone.html">Plone</a>. </p>
<p>tags: <a href="http://davidjb.com/tag/datafs.html">data.fs</a><a href="http://davidjb.com/tag/database.html">database</a><a href="http://davidjb.com/tag/date.html">date</a><a href="http://davidjb.com/tag/fix.html">fix</a><a href="http://davidjb.com/tag/linux.html">linux</a><a href="http://davidjb.com/tag/plone.html">plone</a><a href="http://davidjb.com/tag/python.html">python</a><a href="http://davidjb.com/tag/time.html">time</a><a href="http://davidjb.com/tag/truncate.html">truncate</a><a href="http://davidjb.com/tag/zeo.html">zeo</a><a href="http://davidjb.com/tag/zodb.html">zodb</a><a href="http://davidjb.com/tag/zodb3.html">zodb3</a><a href="http://davidjb.com/tag/zope.html">zope</a></p>
</footer><!-- /.post-info --><p>Okay. So, anyone out here who&#8217;s listening &#8212; particularly those
overly-enthusiastic users &#8212; don&#8217;t try to recursively <tt class="docutils literal">wget</tt> your
Plone site (or other <span class="caps">CMS</span>, for that matter) whilst you&#8217;re logged in with
an account that can make edits. It <strong>will</strong> lead to a very bad situation
where your site administrator and technical team need to step in and fix
your mistakes. For the uninitiated, a loose recursive wget (when logged
in with some degree of Edit rights) will hit every link that&#8217;s on your
pages, and I mean in the (X)<span class="caps">HTML</span> <em>source</em>. For a Plone site, this means
hitting every &#8220;Edit&#8221; link, every &#8220;Revert to this version&#8221; link, and
every other link that might be dangerous when clicked randomly. Oh, and
if the account you&#8217;ve got has admin rights, well, it&#8217;s not getting any
better and requires the Data.fs to be undone back to before it happened.
Here&#8217;s how to do that&nbsp;easily.</p>
<p>So enough of the backstory. How to fix a suitably bollocks&#8217;d Data.fs?
Well, the easy answer is to recover from a backup. Of course you&#8217;ve got
plenty of those, right? No? Oh dear. Never to stress, you can use your
existing Data.fs file and strip away any number of transactions, to
bring your file back to any date, time, or transaction you&#8217;d&nbsp;like.</p>
<ol class="arabic">
<li><p class="first">Realise you&#8217;ll be losing everything from now back until then, so take
a copy of data off your Plone site, back up your Data.fs (twice, if
need be), and make it crystal clear to your users changes are going&nbsp;bye-by.</p>
</li>
<li><p class="first">Figure out when you want to go back to.&nbsp; If you want a particular
transaction, consider checking your Zope Undo log to locate the
specific date/time of a given transaction.&nbsp; Otherwise, figure out the
date and time.&nbsp; Then, convert that date and time to <span class="caps">UTC</span> as that what
date/times are in the Data.fs.&nbsp; In Queensland, Australia, we&#8217;re +10&nbsp;hours.</p>
</li>
<li><p class="first">Shut down <span class="caps">ZEO</span> if it&#8217;s still&nbsp;running.</p>
</li>
<li><p class="first">Edit <tt class="docutils literal">parts/zope2/lib/python/<span class="caps">ZODB</span>/FileStorage/fsdump.py</tt>, and add
this to allow you to run this&nbsp;file:</p>
<pre class="code python literal-block">
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre>
</li>
<li><p class="first">Get your <span class="caps">PYTHONPATH</span> sorted for running this file.&nbsp; Consider
<tt class="docutils literal">./bin/instance1</tt> shell, if you&#8217;ve got a Plone instance, or using
zopepy.&nbsp; Manually update it if&nbsp;necessary.</p>
</li>
<li><p class="first">Run the the <tt class="docutils literal">fsdump.py</tt> script thusly, substituting the date for
yours (or a&nbsp;date/time):</p>
<pre class="code bash literal-block">
./bin/python parts/zope2/lib/python/ZODB/FileStorage/fsdump.py var/filestorage/Data.fs | grep 2010-07-12
</pre>
<p>This will tell you exactly the offset you need to truncate the
Data.fs&nbsp;file.</p>
</li>
<li><p class="first">Take that offset amount and truncate your Data.fs file, inserting the
number after&nbsp;&#8220;seek=&#8221;:</p>
<pre class="code bash literal-block">
dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>var/filestorage/Data.fs <span class="nv">seek</span><span class="o">=</span>199340531 <span class="nv">bs</span><span class="o">=</span>1 <span class="nv">count</span><span class="o">=</span>0
</pre>
</li>
<li><p class="first">Restart your <span class="caps">ZEO</span> service and re-connect to it from your Plone/Zope
instance.&nbsp; Your database should be back to the date and time you
specified.&nbsp; If it&#8217;s close, but not quite right, check your times and
that they&#8217;re&nbsp;<span class="caps">UTC</span>.</p>
</li>
<li><p class="first">Get some backups and politely ask your users to think twice about any
such consequences next&nbsp;time.</p>
</li>
</ol>
<p>And we&#8217;re&nbsp;done!</p>
<p>There are <a href="http://davidjb.com/blog/2010/07/plonezope-truncating-a-data-fs-back-to-a-certain-datetime/#disqus_thread">comments</a>.</p>                </article>
                            </aside><!-- /#featured -->
                            <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">
                                                

                 
                        <li><article class="hentry">    
                <header>
                    <h1><a href="http://davidjb.com/blog/2009/09/migrating-a-plone-site-off-to-another-database-zeo/" rel="bookmark"
                           title="Permalink to Migrating a Plone site off to another databaseÂ (Zeo)">Migrating a Plone site off to another database&nbsp;(Zeo)</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2009-09-30T12:25:00">
                Wed 30 September 2009
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="http://davidjb.com/author/davidjb.html">davidjb</a>
        </address>
        <p>In <a href="http://davidjb.com/category/plone.html">Plone</a>. </p>
<p>tags: <a href="http://davidjb.com/tag/database.html">database</a><a href="http://davidjb.com/tag/export.html">export</a><a href="http://davidjb.com/tag/import.html">import</a><a href="http://davidjb.com/tag/migration.html">migration</a><a href="http://davidjb.com/tag/plone.html">plone</a><a href="http://davidjb.com/tag/site.html">site</a><a href="http://davidjb.com/tag/zeo.html">zeo</a><a href="http://davidjb.com/tag/zodb.html">zodb</a></p>
</footer><!-- /.post-info -->                <p>Another of the interesting things in my professional life has been
migrating a Plone site from one database (where it lived as a dev site,
along with many others) onto a nice, clean database of its own.&nbsp; Now,
yes, I&#8217;m aware that the export/import feature of Zope <strong>isn ...</strong></p>
                <a class="readmore" href="http://davidjb.com/blog/2009/09/migrating-a-plone-site-off-to-another-database-zeo/">read more</a>
                <p>There are <a href="http://davidjb.com/blog/2009/09/migrating-a-plone-site-off-to-another-database-zeo/#disqus_thread">comments</a>.</p>                </div><!-- /.entry-content -->
            </article></li>
                            </ol><!-- /#posts-list -->
                            <p class="paginator">
        Page 1 / 1
    </p>
                        </section><!-- /#content -->
                    <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://planet.plone.org">Planet Plone</a></li>
                                                    <li><a href="http://jcu.me">jcu.me Research Porfolio</a></li>
                                                    <li><a href="http://xckd.com">XKCD</a></li>
                                                    <li><a href="http://appleinsider.com/">Apple Insider</a></li>
                                                    <li><a href="http://git.io/djb">Latest coding activity</a></li>
                                                    <li><a href="http://www.ozbargain.com.au">OzBargain</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://davidjb.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="http://git.io/djb">GitHub</a></li>
                                                    <li><a href="http://twitter.com/davidjb_">Twitter</a></li>
                                                    <li><a href="http://linkedin.com/in/davidbeitey">LinkedIn</a></li>
                                                    <li><a href="http://facebook.com/david.beitey">Facebook</a></li>
                                                    <li><a href="https://plus.google.com/u/0/106527454335411502430">Google+</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24253455-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'davidjb';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>