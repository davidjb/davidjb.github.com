<!DOCTYPE html>
<html lang="en">
<head>
        <title>Plone: SiteManager leftovers; not the good kind</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://davidjb.com/theme/css/main.css" type="text/css" />
                <link href="http://davidjb.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="DavidJB.com Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://davidjb.com/css/ie.css"/>
                <script src="http://davidjb.com/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://davidjb.com/css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://davidjb.com/">DavidJB.com  <strong>Ramblings about Plone, Pyramid, Python, the web, Linux, roses and more.</strong></a></h1>
                <nav><ul>
                                                    <li><a href="http://davidjb.com/about.html">About&nbsp;me</a></li>
                                    <li><a href="http://davidjb.com/blog/index.html">Blog</a></li>
                                    <li><a href="http://davidjb.com/projects.html">Projects</a></li>
                                                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="http://davidjb.com/blog/2010/06/plone-sitemanager-leftovers-not-the-good-kind/" rel="bookmark"
           title="Permalink to Plone: SiteManager leftovers; not the good kind">Plone: SiteManager leftovers; not the good&nbsp;kind</a></h1>
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="davidjb_">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2010-06-28T14:35:00">
                Mon 28 June 2010
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="http://davidjb.com/author/davidjb.html">davidjb</a>
        </address>
        <p>In <a href="http://davidjb.com/category/plone.html">Plone</a>. </p>
<p>tags: <a href="http://davidjb.com/tag/egg.html">egg</a><a href="http://davidjb.com/tag/error.html">error</a><a href="http://davidjb.com/tag/install.html">install</a><a href="http://davidjb.com/tag/plone.html">plone</a><a href="http://davidjb.com/tag/problem.html">problem</a><a href="http://davidjb.com/tag/site.html">site</a><a href="http://davidjb.com/tag/update.html">update</a><a href="http://davidjb.com/tag/zope.html">zope</a></p>
</footer><!-- /.post-info -->      <div class="note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Update:</strong> You should check out <a class="reference external" href="http://pypi.python.org/pypi/wildcard.fixpersistentutilities">wildcard.fixpersistentutilities</a>
- it&#8217;s a fantastic solution to problems like this. Many thanks to
Nathan Van Gheem, the author of the add on. Check out the link and
see how to install it (temporarily) on your Plone instance that
needs its site manager cleaned&nbsp;up.</p>
</div>
<p>Leftovers are typically useful when they&#8217;re in your fridge at home. They
mean you don&#8217;t have to mess around making lunch for the next day for
work, and can just grab them, and walk right out the door. Now,
leftovers in the zope.component SiteManager aren&#8217;t so nice, especially
when some Plone products fail to remove what they&#8217;ve registered. The
consequences of this are that you&#8217;ve got references left which will
break things when you uninstall/remove the physical eggs/files. These
leftovers would be ones would be mutated food that comes to kill you
after you&#8217;ve thrown it in the bin, assuming we follow the same analogy.
But how to fix&nbsp;them?</p>
<p>Here&#8217;s the error message you might be faced with when trying to install
or uninstall products &#8212; something that stops you might in your&nbsp;tracks:</p>
<pre class="code pytb literal-block">
<span class="x">2010-06-22T10:38:48 <span class="caps">ERROR</span> Zope.SiteErrorLog https://mysite.com/portal_quickinstaller/uninstallProducts
Traceback (innermost last):
Module ZPublisher.Publish, line 125, in publish
Module Zope2.App.startup, line 238, in commit
Module transaction._manager, line 96, in commit
Module transaction._transaction, line 395, in commit
Module transaction._transaction, line 495, in _commitResources
Module <span class="caps">ZODB</span>.Connection, line 510, in commit
Module <span class="caps">ZODB</span>.Connection, line 555, in _commit
Module <span class="caps">ZODB</span>.Connection, line 582, in _store_objects
Module <span class="caps">ZODB</span>.serialize, line 407, in serialize
Module <span class="caps">ZODB</span>.serialize, line 416, in _dump
PicklingError: Can't pickle &lt;class 'p4a.plonevideoembed.interfaces.IVideoLinkSupport'&gt;: import of module p4a.plonevideoembed.interfaces failed</span>
</pre>
<p>Unsurprisingly, it&#8217;s similar to something I encountered before. Way back
when, I hit the same issue with <a class="reference external" href="http://davidjb.com/blog/2009/04/plone-issues-with-products/">ZipFileTransport</a>, and my fix for it
is just as relevant today as it was then. Start up a zopepy session (or
ipython) that still has the relevant classes in the system path, and run&nbsp;this:</p>
<pre class="code python literal-block">
<span class="kn">from</span> <span class="nn">p4a.plonevideoembed.interfaces</span> <span class="kn">import</span> <span class="n">IVideoLinkSupport</span> <span class="k">as</span> <span class="n">intclass</span>
<span class="kn">from</span> <span class="nn">p4a.video.interfaces</span> <span class="kn">import</span> <span class="n">IVideoSupport</span> <span class="k">as</span> <span class="n">intclass2</span>

<span class="kn">from</span> <span class="nn">zope.app.component.hooks</span> <span class="kn">import</span> <span class="n">setSite</span>
<span class="kn">from</span> <span class="nn">zope.component</span> <span class="kn">import</span> <span class="n">getSiteManager</span>
<span class="n">setSite</span><span class="p">(</span><span class="n">portal</span><span class="p">)</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">getSiteManager</span><span class="p">()</span>
<span class="n">sm</span><span class="o">.</span><span class="n">unregisterUtility</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">provided</span><span class="o">=</span><span class="n">intclass</span><span class="p">)</span>
<span class="n">sm</span><span class="o">.</span><span class="n">unregisterUtility</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">provided</span><span class="o">=</span><span class="n">intclass2</span><span class="p">)</span>

<span class="c">#Even though unregister happened, it probably said it worked but left crap around.</span>
<span class="c">#Let's clean it up.</span>

<span class="c">#This intclass variables might not be right or perfectly complete. It's going to be the key present below,</span>
<span class="c">#so you can always find the right InterfaceClass manually and set it accordingly.</span>
<span class="k">del</span> <span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">_adapters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">intclass</span><span class="p">]</span>
<span class="k">del</span> <span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">_subscribers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">intclass</span><span class="p">]</span>
<span class="k">del</span> <span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">_subscribers</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">intclass2</span><span class="p">]</span>
<span class="k">del</span> <span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">_adapters</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">intclass2</span><span class="p">]</span>

<span class="c">#From here, search for a term to see if it's gone</span>
<span class="c">#Each should return -1. If not, you've done something wrong!</span>
<span class="nb">str</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">_adapters</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'p4a'</span><span class="p">)</span>
<span class="nb">str</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">_subscribers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'p4a'</span><span class="p">)</span>
<span class="nb">str</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">__bases__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">'p4a'</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">transaction</span>
<span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre>
<p>Shut down your existing Plone/Zope instance and restart it. You should
now be able to install or remove products accordingly again &#8212; and also
get rid of those old packages&#8217; physical files you don&#8217;t&nbsp;need.</p>

    </div><!-- /.entry-content -->
        <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "blog/2010/06/plone-sitemanager-leftovers-not-the-good-kind/";
        var disqus_url = "http://davidjb.com/blog/2010/06/plone-sitemanager-leftovers-not-the-good-kind/";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://davidjb.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>
    
  </article>
</section>
        <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://planet.plone.org">Planet Plone</a></li>
                                                    <li><a href="http://jcu.me">jcu.me Research Porfolio</a></li>
                                                    <li><a href="http://xckd.com">XKCD</a></li>
                                                    <li><a href="http://appleinsider.com/">Apple Insider</a></li>
                                                    <li><a href="http://git.io/djb">Latest coding activity</a></li>
                                                    <li><a href="http://www.ozbargain.com.au">OzBargain</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://davidjb.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="http://git.io/djb">GitHub</a></li>
                                                    <li><a href="http://twitter.com/davidjb_">Twitter</a></li>
                                                    <li><a href="http://linkedin.com/in/davidbeitey">LinkedIn</a></li>
                                                    <li><a href="http://facebook.com/david.beitey">Facebook</a></li>
                                                    <li><a href="https://plus.google.com/u/0/106527454335411502430">Google+</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-24253455-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'davidjb';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>